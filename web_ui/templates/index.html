<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Automated ePortem Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f9f9f9; }
        h1 { color: #333; }
        .toggle-group { margin-bottom: 1.5em; }
        .toggle-label { margin-right: 1em; }
        table { border-collapse: collapse; width: 100%; background: #fff; }
        th, td { border: 1px solid #ccc; padding: 0.5em 1em; text-align: center; }
        th { background: #eee; }
        tr:nth-child(even) { background: #f5f5f5; }
        .btn { padding: 0.3em 0.8em; margin: 0 0.2em; border: none; border-radius: 3px; cursor: pointer; }
        .btn-add { background: #4caf50; color: #fff; }
        .btn-remove { background: #f44336; color: #fff; }
        .toggle-switch { vertical-align: middle; }
    </style>
</head>
<body>
    <nav style="display: flex; justify-content: space-between; align-items: center; padding: 0.8em 2em 0.8em 2em; background: #e3f2fd; border-radius: 0 0 7px 7px; margin-bottom: 1em;">
      <div>
        <a href="/" style="text-decoration: none; font-size: 1.4em; font-weight: bold; color: #1565c0; letter-spacing: 0.02em;">Home</a>
      </div>
      <button id="settings-btn" style="background: none; border: none; cursor: pointer;">
        <span style="font-size: 2em; color: #1565c0;" title="Settings">&#9881;</span>
      </button>
    </nav>
    <h1>ePortem Web UI</h1>
    <div class="toggle-group">
        <label class="toggle-label">
            <input type="checkbox" id="updates_enabled" class="toggle-switch"> Updates Enabled
        </label>

        <label class="toggle-label">
            <input type="checkbox" id="telegram_enabled" class="toggle-switch"> Telegram Updates
        </label>
        <label class="toggle-label">
            <input type="checkbox" id="slack_enabled" class="toggle-switch"> Slack Updates
        </label>
        <label class="toggle-label">
            <input type="checkbox" id="slack_status_enabled" class="toggle-switch"> Slack Status
        </label>
    </div>
    <h2>Schedule</h2>
    <div style="display: flex; gap: 1em; margin-bottom:1em;">
      <div id="manual-trigger-box" style="flex:1; background:#f0f6ff; border:1px solid #90caf9; color:#134975; padding:0.7em 1.2em; border-radius:4px;">
        <strong>Trigger Action Now</strong>
        <form id="manual-action-form" style="margin-top:0.7em;">
          <label>
            <select id="manual-action">
              <option value="start_day">Start Day</option>
              <option value="lunch_break">Lunch Break</option>
              <option value="after_lunch">After Lunch</option>
              <option value="stop_day">Stop Day</option>
            </select>
          </label>
          <label>
            <select id="manual-location">
              <option value="office">Office</option>
              <option value="home">Home</option>
            </select>
          </label>
          <label style="margin-left:0.7em;">
            <input type="checkbox" id="manual-telegram" checked> Telegram
          </label>
          <label style="margin-left:0.7em;">
            <input type="checkbox" id="manual-slack" checked> Slack Updates
          </label>
          <label style="margin-left:0.7em;">
            <input type="checkbox" id="manual-slack-status" checked> Slack Status
          </label>
          <button class="btn btn-add" type="button" style="margin-left:0.7em;" onclick="triggerManualAction()">Trigger</button>
        </form>
        <div id="manual-action-result" style="margin-top:0.5em;font-size:0.95em;"></div>
      </div>
      <div id="scheduler-status" style="flex:1; background:#f0f6ff; border:1px solid #90caf9; color:#134975; padding:0.7em 1.2em; border-radius:4px;">
        <strong>Scheduler Status:</strong><br>
        <span id="upcoming-action">Upcoming action: <em>Not</em> available</em></span>
        <span id="countdown"></span><br>
        <span id="last-action-result">Last action result: <em></em>Not available</em></span>
      </div>
    </div>
    <div style="margin-bottom:1em;">
      <div style="display: flex; align-items: center; gap: 1em; margin-bottom:1em;">
        <button id="today-btn" type="button" class="btn btn-add" style="padding:0.2em 1em;">Today</button>
        <span style="font-weight:600; margin-left:0.5em; margin-right:0.5em;">Show:</span>
        <div id="day-toggles" style="display:flex;gap:0.5em;align-items: center;">
          <label><input type="checkbox" class="day-toggle" value="Monday" checked> Mon</label>
          <label><input type="checkbox" class="day-toggle" value="Tuesday" checked> Tue</label>
          <label><input type="checkbox" class="day-toggle" value="Wednesday" checked> Wed</label>
          <label><input type="checkbox" class="day-toggle" value="Thursday" checked> Thu</label>
          <label><input type="checkbox" class="day-toggle" value="Friday" checked> Fri</label>
          <button type="button" class="btn btn-add" id="all-days-btn" style="margin-left:1em;">All</button>
        </div>
      </div>
    </div>
    <table id="schedule_table">
        <thead>
            <tr>
                <th>Day</th>
                <th>Time</th>
                <th>Action</th>
                <th>Location</th>
                <th>Enabled</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be populated by JS -->
        </tbody>
    </table>
    <div style="margin-top:1em; margin-bottom:1em; background:#f0f6ff; border:1px solid #90caf9; color:#134975; padding:0.9em 1.5em; border-radius:4px;">
      <div style="display:flex; align-items: center; gap:1em; flex-wrap:wrap;">
        <span style="font-weight:600; margin-right:0.7em;">Add Row to Schedule:</span>
        <input type="time" id="new_time">
        <select id="new_action">
            <option value="start_day">Start Day</option>
            <option value="lunch_break">Lunch Break</option>
            <option value="after_lunch">After Lunch</option>
            <option value="stop_day">Stop Day</option>
        </select>
        <select id="new_location" style="min-width:90px;">
            <option value="office">Office</option>
            <option value="home">Home</option>
        </select>
        <div id="bulk-days" style="display:flex; gap:0.3em;">
            <label><input type="checkbox" class="bulk-day" value="Monday" checked> Mon</label>
            <label><input type="checkbox" class="bulk-day" value="Tuesday" checked> Tue</label>
            <label><input type="checkbox" class="bulk-day" value="Wednesday" checked> Wed</label>
            <label><input type="checkbox" class="bulk-day" value="Thursday" checked> Thu</label>
            <label><input type="checkbox" class="bulk-day" value="Friday" checked> Fri</label>
        </div>
        <button class="btn btn-add" onclick="addRow()">Add Row</button>
      </div>
    </div>
    <script>
       let state = {};
       function getTodayStr() {
           const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
           return days[new Date().getDay()];
       }

       function fetchSchedulerStatus() {
           fetch('/api/scheduler_status').then(r => r.json()).then(status => {
               document.getElementById('upcoming-action').innerHTML =
                   'Upcoming action: ' +
                   (status.upcoming_action ? status.upcoming_action : '<em>Not available</em>');
               document.getElementById('last-action-result').innerHTML =
                   'Last action result: ' +
                   (status.last_action_result ? status.last_action_result : '<em>Not available</em>');
               // Parse out HH:MM and show countdown if possible
               if (status.upcoming_action) {
                   // Try to extract HH:MM and Day, e.g. "Start day at 09:00 (Friday)"
                   const m = status.upcoming_action.match(/at (\d\d?:\d\d) \((\w+)\)/);
                   if (m) {
                       const targetTime = m[1];
                       const targetDay = m[2];
                       updateCountdown(targetTime, targetDay);
                   } else {
                       document.getElementById('countdown').innerHTML = '';
                   }
               } else {
                   document.getElementById('countdown').innerHTML = '';
               }
           }).catch(() => {
               document.getElementById('upcoming-action').innerHTML = 'Upcoming action: <em>Not available</em>';
               document.getElementById('countdown').innerHTML = '';
               document.getElementById('last-action-result').innerHTML = 'Last action result: <em>Not available</em>';
           });
       }

       function fetchState() {
           fetch('/api/state').then(r => r.json()).then(data => {
               state = data;
               document.getElementById('updates_enabled').checked = state.updates_enabled;

               document.getElementById('telegram_enabled').checked = state.telegram_enabled;
               document.getElementById('slack_enabled').checked = state.slack_enabled;
               document.getElementById('slack_status_enabled').checked = state.slack_status_enabled;
               renderSchedule(state.schedule);
               fetchSchedulerStatus();
           });
       }
        function toggle(key, value) {
            fetch('/api/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({key, value})
            }).then(fetchState);
        }

        function triggerManualAction() {
            const action = document.getElementById('manual-action').value;
            const location = document.getElementById('manual-location').value;
            const telegram = document.getElementById('manual-telegram').checked;
            const slack = document.getElementById('manual-slack').checked;
            const slackStatus = document.getElementById('manual-slack-status').checked;
            document.getElementById('manual-action-result').textContent = "Triggering...";
            fetch('/api/trigger_now', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action, location,
                    telegram, slack, slack_status: slackStatus
                })
            })
            .then(r => r.json())
            .then(resp => {
                if (resp.success) {
                    document.getElementById('manual-action-result').innerHTML =
                        '<span style="color:#388e3c;">' + (resp.result || 'Action triggered!') + '</span>';
                } else {
                    document.getElementById('manual-action-result').innerHTML =
                        '<span style="color:#b71c1c;">Error: ' + (resp.error || 'Unknown error') + '</span>';
                }
            })
            .catch(() => {
                document.getElementById('manual-action-result').innerHTML =
                    '<span style="color:#b71c1c;">Error: Could not reach server.</span>';
            });
        }
        document.getElementById('updates_enabled').onchange = e => toggle('updates_enabled', e.target.checked);

        document.getElementById('telegram_enabled').onchange = e => toggle('telegram_enabled', e.target.checked);
        document.getElementById('slack_enabled').onchange = e => toggle('slack_enabled', e.target.checked);
        document.getElementById('slack_status_enabled').onchange = e => toggle('slack_status_enabled', e.target.checked);
        function getSelectedDays() {
            // Return array of days to show
            const toggles = document.querySelectorAll('.day-toggle:checked');
            return Array.from(toggles).map(x => x.value);
        }

        function renderSchedule(schedule) {
            const selectedDays = getSelectedDays();
            const tbody = document.getElementById('schedule_table').querySelector('tbody');
            tbody.innerHTML = '';
            if (selectedDays.length === 0) return;
            schedule.forEach(row => {
                if (!selectedDays.includes(row.day)) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.day ? row.day : ''}</td>
                   <td>
                       <span class="time-cell" data-id="${row.id}" style="cursor:pointer;text-decoration:underline;">${row.time}</span>
                   </td>
                    <td>${row.action.replace('_', ' ')}</td>
                    <td>
                        <span class="location-cell" data-id="${row.id}" style="cursor:pointer;text-decoration:underline;">${row.location ? row.location : ''}</span>
                    </td>
                    <td>
                        <input type="checkbox" ${row.enabled ? 'checked' : ''} onchange="toggleRow(${row.id})">
                    </td>
                    <td>
                        <button class="btn btn-remove" onclick="removeRow(${row.id})">Remove</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            // Add event listeners after rendering
            document.querySelectorAll('.location-cell').forEach(el => {
                el.onclick = function (e) {
                    const id = parseInt(this.getAttribute('data-id'));
                    const prevValue = this.textContent.trim().toLowerCase();
                    const select = document.createElement('select');
                    const options = ['home', 'office'];
                    options.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc;
                        option.textContent = loc.charAt(0).toUpperCase() + loc.slice(1);
                        if (prevValue === loc) option.selected = true;
                        select.appendChild(option);
                    });
                    select.onblur = function () {
                        updateLocation(id, select.value);
                    };
                    select.onchange = function () {
                        updateLocation(id, select.value);
                    };
                    this.replaceWith(select);
                    select.focus();
                };
            });

            document.querySelectorAll('.time-cell').forEach(el => {
                el.onclick = function (e) {
                    const id = parseInt(this.getAttribute('data-id'));
                    const prevValue = this.textContent.trim();
                    const input = document.createElement('input');
                    input.type = 'time';
                    input.value = prevValue;
                    input.style.width = '75px';
                    input.onblur = function () {
                        updateTime(id, input.value);
                    };
                    input.onkeydown = function (evt) {
                        if (evt.key === 'Enter') {
                            input.blur();
                        }
                    };
                    this.replaceWith(input);
                    input.focus();
                }
            });
        }
        function toggleRow(id) {
            fetch('/api/schedule/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id})
            }).then(fetchState);
        }

        function updateLocation(id, location) {
            fetch('/api/schedule/update_location', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, location})
            }).then(fetchState);
        }
        function addRow() {
            const time = document.getElementById('new_time').value;
            const action = document.getElementById('new_action').value;
            const location = document.getElementById('new_location').value;
            const days = Array.from(document.querySelectorAll('.bulk-day:checked')).map(cb => cb.value);
            if (!time || !action || days.length === 0) return alert('Please select time, action, and at least one day');
            fetch('/api/schedule/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({time, action, days, location})
            }).then(fetchState);
        }

        function updateTime(id, time) {
            fetch('/api/schedule/update_time', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, time})
            }).then(fetchState);
        }

        function removeRow(id) {
            fetch('/api/schedule/remove', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id})
            }).then(fetchState);
        }
       // Calculate and update countdown every 5s
       let countdownTimer = null;
       function updateCountdown(targetTime, targetDay) {
           if (countdownTimer) clearInterval(countdownTimer);
           function update() {
               const now = new Date();
               // Parse day index
               const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
               let dayIdxNow = now.getDay();
               let dayIdxTarget = days.indexOf(targetDay);
               if (dayIdxTarget === -1) { document.getElementById('countdown').innerHTML = ''; return; }
               // Parse target time
               const [hh, mm] = targetTime.split(':').map(x => parseInt(x, 10));
               let nextAction = new Date(now);
               nextAction.setHours(hh, mm, 0, 0);
               // If target day is in the past (this week), roll forward
               let daysDiff = dayIdxTarget - dayIdxNow;
               if (daysDiff < 0 || (daysDiff === 0 && nextAction < now)) {
                   daysDiff += 7;
               }
               nextAction.setDate(now.getDate() + daysDiff);
               // If target day is today but target time has passed, go to next week
               if (daysDiff === 0 && nextAction < now) {
                   nextAction.setDate(nextAction.getDate() + 7);
               }
               const diffMs = nextAction - now;
               if (diffMs <= 0) {
                   document.getElementById('countdown').innerHTML = ' <span style="color:#b71c1c">(now)</span>';
                   return;
               }
               const diffMin = Math.floor(diffMs / 60000);
               const hr = Math.floor(diffMin / 60);
               const min = diffMin % 60;
               let txt = ' <span style="color:#1976d2">(' + (hr > 0 ? hr + ' hr ' : '') + min + ' min left)</span>';
               document.getElementById('countdown').innerHTML = txt;
           }
           update();
           countdownTimer = setInterval(update, 5000);
       }

       // Apply filter on change of day toggles
       document.addEventListener('DOMContentLoaded', function () {
            fetchState();
            fetchSchedulerStatus();
            document.querySelectorAll('.day-toggle').forEach(cb => {
                cb.addEventListener('change', function() {
                    renderSchedule(state.schedule);
                });
            });
            document.getElementById('today-btn').onclick = function() {
                 const todayStr = getTodayStr();
                 document.querySelectorAll('.day-toggle').forEach(cb => {
                     cb.checked = (cb.value === todayStr);
                 });
                 renderSchedule(state.schedule);
             };
             // Add behavior for "All" button to select/deselect all
             document.getElementById('all-days-btn').onclick = function() {
                 const toggles = document.querySelectorAll('.day-toggle');
                 const allChecked = Array.from(toggles).every(cb => cb.checked);
                 toggles.forEach(cb => cb.checked = !allChecked);
                 renderSchedule(state.schedule);
             };
         });
    // SETTINGS MODAL LOGIC
    let settingsModal, envTextarea, envSaveBtn, envError, envSuccess;
    function showSettingsModal() {
        settingsModal.style.display = "flex";
        envError.textContent = "";
        envSuccess.textContent = "";
        envTextarea.value = "Loading...";
        fetch("/api/env")
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    envTextarea.value = d.content;
                } else {
                    envTextarea.value = "";
                    envError.textContent = "Error: " + (d.error || "Could not load .env file.");
                }
            }).catch(() => {
                envTextarea.value = "";
                envError.textContent = "Network error loading config.";
            });
    }
    function hideSettingsModal() {
        settingsModal.style.display = "none";
    }
    function saveEnvFile() {
        envError.textContent = "";
        envSuccess.textContent = "";
        fetch("/api/env", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: envTextarea.value})
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                envSuccess.textContent = "Saved!";
            } else {
                envError.textContent = "Error saving: " + (d.error || "Unknown error");
            }
        }).catch(() => {
            envError.textContent = "Network error saving config.";
        });
    }
    document.addEventListener("DOMContentLoaded", function() {
        settingsModal = document.getElementById("settings-modal");
        envTextarea = document.getElementById("env-textarea");
        envSaveBtn = document.getElementById("env-save-btn");
        envError = document.getElementById("env-error");
        envSuccess = document.getElementById("env-success");

        // Fetch and display server info (start time and uptime)
        function loadServerInfo() {
            fetch("/api/serverinfo").then(r => r.json()).then(d => {
                if (d.success) {
                    // Format start time
                    let dt = new Date(d.start_time);
                    let dtStr = dt.toLocaleString();
                    document.getElementById("server-start-time").textContent = dtStr;
                    // Format uptime
                    let out = "";
                    if (d.uptime_days) out += d.uptime_days + " days ";
                    if (d.uptime_hours || out) out += d.uptime_hours + " hr ";
                    out += d.uptime_minutes + " min";
                    document.getElementById("server-uptime").textContent = out;
                } else {
                    document.getElementById("server-start-time").textContent = "Error";
                    document.getElementById("server-uptime").textContent = "";
                }
            }).catch(() => {
                document.getElementById("server-start-time").textContent = "Error";
                document.getElementById("server-uptime").textContent = "";
            });
        }

        document.getElementById("settings-btn").onclick = function() {
            showSettingsModal();
            loadServerInfo();
        };
        document.getElementById("settings-modal-close").onclick = hideSettingsModal;
        envSaveBtn.onclick = function() {
            saveEnvFile();
            document.getElementById("restart-warning").style.fontWeight = "900";
            document.getElementById("restart-warning").style.color = "#e65100";
        };
        document.getElementById("env-restart-btn").onclick = function() {
            if (confirm("Are you sure you want to restart the Web UI? Any changes not saved will be lost, and the UI may be temporarily unavailable.")) {
                fetch("/api/restart", {method: "POST"})
                  .then(r=>r.json()).then(d=>{
                    if (d.success) {
                      envSuccess.textContent = "Restart requested. The UI will reload if the server is running with restart policy (e.g., Docker or systemd).";
                      setTimeout(function(){ location.reload(); }, 2000);
                    } else {
                      envError.textContent = "Error: Could not restart: " + (d.error || "");
                    }
                  })
                  .catch(()=>{ envError.textContent = "Error: Could not contact server for restart."; });
            }
        };
        // Also allow clicking the backdrop to close:
        settingsModal.onclick = function(e){
            if (e.target === settingsModal) hideSettingsModal();
        };
    });
    </script>
<!-- SETTINGS MODAL -->
<div id="settings-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:50;align-items:center;justify-content:center;background:rgba(22,22,22,0.33);">
    <div style="background:#fff;min-width:410px;max-width:90vw;padding:2em 2em 1.2em 2em;border-radius:7px;box-shadow:0 0 14px 0 rgba(20,50,130,0.16);position:relative;">
        <button id="settings-modal-close" style="position:absolute;top:1.2em;right:1.2em;background:none;border:none;font-size:1.2em;cursor:pointer;color:#333;">&times;</button>
        <h2 style="margin-top:0;margin-bottom:0.7em;font-size:1.2em;color:#1565c0;">Edit .env Settings</h2>
        <div id="server-start-info" style="margin-bottom:0.6em;font-size:1em;color:#444;">
            <span>Server started: <span id="server-start-time" style="font-weight:600;">Loading...</span><br>
            Uptime: <span id="server-uptime" style="color:#1976d2;font-weight:600;">Loading...</span></span>
        </div>
        <div style="margin-bottom:0.9em;">
            <textarea id="env-textarea" style="width:100%;min-height:230px;font-family: monospace;font-size:1em;border-radius:3px;border:1px solid #bdbdbd;resize:vertical;padding:0.5em 0.7em;"></textarea>
        </div>
        <div>
            <button id="env-save-btn" class="btn btn-add" style="font-size:1em;">Save</button>
            <button id="env-restart-btn" class="btn btn-add" style="margin-left:1em;background:#f9a825;color:#fff;font-weight:600;border:1px solid #bdb76b;">Restart UI</button>
            <span id="env-success" style="color:#2e7d32;font-weight:500;"><!-- Success msg --></span>
            <span id="env-error" style="color:#b71c1c;font-weight:500;margin-left:1.2em;"><!-- Error msg --></span>
        </div>
        <div style="margin-top:0.7em;color:#c57a00;font-weight:500;">
            <span id="restart-warning">If you change any settings above, you must restart the UI for changes to take effect.</span>
        </div>
    </div>
</div>
</body>
</html>
